<style>
    .batElement {
        stroke-width: 1;
        stroke:#78828C;
    }

    .lineElement {
        fill: #000;
        stroke: #bfbfbf;
    }
</style>

<svg viewBox="0 0 345 345" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">

    <defs>
        <g id="bat_symbol">
            <rect id="batE4" class="batElement" x="0" y="0"  width="20" height="10" fill="#c3c3c3"/>
            <polyline class="batElement" points="0,0 6,-6 26,-6 20,0" fill="#e6e6e6"/>
            <polyline class="batElement" points="26,-6 26,4 20,10 20,0" fill="#e6e6e6"/>
            <polyline class="batElement" points="26,4 26,12 20,18" fill="#e6e6e6"/>
            <polyline class="batElement" points="26,12 26,20 20,26 " fill="#e6e6e6"/>
            <polyline class="batElement" points="26,20 26,28 20,34 " fill="#e6e6e6"/>
            <polyline class="batElement" points="26,28 26,32 20,38 " fill="#e6e6e6"/>

            <rect id="batE3" class="batElement" x="0" y="10" width="20" height="8"  fill="#F3F3F3"/>
            <rect id="batE2" class="batElement" x="0" y="18" width="20" height="8" fill="#F3F3F3"/>
            <rect id="batE1" class="batElement" x="0" y="26" width="20" height="8" fill="#F3F3F3"/>
            <rect id="batE0" class="batElement" x="0" y="34" width="20" height="4" fill="#F3F3F3"/>
            <circle id="batOnOff" cx="4" cy="4" r="3" stroke="#c3c3c3" fill="#00cc00"/>
        </g>
        
        <g id="g_inverter">
            <circle id="cInv" r="30" stroke="#c3c3c3" fill="#FFFFFF"></circle>
            <image href="/vis.0/Strom/img/wechselrichter.png" 
            x="-19" 
            y="-20" 
            height="40" 
            width="40"
            preserveAspectRatio="xMinYMin meet"
            /> 
        </g>
        
        <g id="g_production">
            <circle id="cSolar" r="40" stroke="#E0BA34" fill="#FFFDF4"></circle>
            <image href="/vis.0/Strom/img/solar.png" 
            x="-20" 
            y="-33" 
            height="40" 
            width="40"
            opacity="20%"
            preserveAspectRatio="xMinYMin meet"
            />
        </g>
        
        <g id="g_grid">
            <circle id="cGrid" r="40" stroke="#474747" fill="#F3F3F3"></circle>
            <image href="/vis.0/Strom/img/grid.png" 
            x="-25" 
            y="-25" 
            height="50" 
            width="50"
            opacity="75%"
            preserveAspectRatio="xMinYMin meet"
            />
        </g>
        
        <g id="g_battery">
            <circle id="cBattery" r="40" stroke="#6CBE58" fill="#EFFAEC"></circle>
            <use xlink:href="#bat_symbol" x="-13" y="-25"/>
            <text id="percBat" x="0" y="30" text-anchor="middle" font-size="small" fill="#03152C">100%</text>
        </g>        
        
        <g id="g_house">
            <circle id="cHouse" r="40" stroke="#70AFCD" fill="#F4F9FB"></circle>
            <image href="/vis.0/Strom/img/haus.png" 
            x="-25" 
            y="-25" 
            height="50" 
            width="50"
            opacity="50%"
            preserveAspectRatio="xMinYMin meet"
            />
        </g>          
        
        <g id="g_car">
            <circle id="cCar" r="40" stroke="#78828C" fill="#ffffff"></circle>
            <image href="/vis.0/Strom/img/enyaq.png" 
            x="-40" 
            y="-30" 
            height="80" 
            width="80"
            preserveAspectRatio="xMinYMin meet"
            />
        </g>
    </defs>
    
     <line id="prod_line" class="lineElement" x1="10" y1="10" x2="150" y2="150" visibility="hidden"></line>
     <line id="grid_line" class="lineElement" x1="10" y1="10" x2="150" y2="150" visibility="hidden"></line> 
     <line id="bat_line" class="lineElement" x1="10" y1="10" x2="150" y2="150" visibility="hidden"></line>
     <line id="house_line" class="lineElement" x1="10" y1="10" x2="150" y2="150" visibility="hidden"></line>
     <line id="car_line" class="lineElement" x1="10" y1="10" x2="150" y2="150" visibility="hidden"></line>
     
     <circle id="prod_circle1" r="7" cx="180" cy="45" fill="#E0BA34" visibility="hidden">
        <animateMotion path="M0,0 0 135" dur="1.5s" repeatCount="indefinite" />
    </circle>

    <circle id="grid_circle1" r="7" cx="45" cy="125" fill="#474747" visibility="hidden">
        <animateMotion path="M0,0 135 75" dur="1.5s" repeatCount="indefinite" />
    </circle>

    <circle id="bat_circle1" r="7" cx="45" cy="300" fill="#6CBE58" visibility="hidden">
        <animateMotion path="M0,0 135 -100" dur="1.5s" repeatCount="indefinite" />
    </circle>

    <circle id="house_circle1" r="7" cx="300" cy="125" fill="#70AFCD" visibility="hidden">
        <animateMotion path="M0,0 -120 75" dur="1.5s" repeatCount="indefinite" />
    </circle>

    <circle id="car_circle1" r="7" cx="300" cy="300" fill="#78828C" visibility="hidden">
        <animateMotion path="M0,0 -120 -100" dur="1.5s" repeatCount="indefinite" />
    </circle>
    

    <use xlink:href="#g_inverter" id="inv_group" x="180" y="200" visibility="hidden"/>
    <use xlink:href="#g_production" id="prod_group" x="180" y="45" visibility="hidden"/>
    <use xlink:href="#g_grid" id="grid_group" x="45" y="125" visibility="hidden"/>
    <use xlink:href="#g_battery" id="bat_group" x="45" y="300" visibility="hidden"/>
    <use xlink:href="#g_house" id="house_group" x="300" y="125" visibility="hidden"/>
    <use xlink:href="#g_car" id="car_group" x="300" y="300" visibility="hidden"/>

    <text id="prod_text_watt" x="180" y="65" visibility="hidden" text-anchor="middle" font-size="small" fill="#03152C">--</text>    
    <text id="grid_text_watt" x="45" y="80" visibility="hidden" text-anchor="middle" font-size="small" fill="#03152C" >--- W</text>
    <text id="house_text_watt" x="300" y="80" visibility="hidden" text-anchor="middle" font-size="small" fill="#03152C" >--- W</text>
    <text id="bat_text_watt" x="45" y="255" visibility="hidden" text-anchor="middle" font-size="small" fill="#03152C">-- W</text>
    <text id="car_text_watt" x="300" y="255" visibility="hidden" text-anchor="middle" font-size="small" fill="#03152C" >-- W</text>
    <text id="car_text_perc" x="300" y="330" visibility="hidden" text-anchor="middle" font-size="small" fill="#03152C">-%</text>

</svg>

<script type="text/javascript">
    
    (function(){
        //define Array of Objects which values are gotten from server
        let objIDs = [
        'javascript.0.solar.current_production',
        'javascript.0.solar.toBattery',
        'modbus.0.holdingRegisters.200.40087_W',
        'javascript.0.solar.curConsumptionHouse',
        'mqtt.0.wattpilot.properties.nrg_ptotal.state',
        'vw-connect.0.xxxxxxxxxx.status.charging.status.battery.stateOfChargeInPercent',
        'modbus.0.holdingRegisters.1.40351_ChaState',
        'modbus.0.holdingRegisters.1.40354_ChaSt'
        ];
            
        var allFlowObjects = ['inv', 'prod', 'grid', 'bat', 'house', 'car'];
        var flowValues = { //initialize values used in the widget
            "prod": 0,
            "bat": 0,
            "grid": 0,
            "house": 0,
            "car": 0,
            "carChSt": 0,
            "batChSt": 0,
            "batStatus": 0
        }    

        //define Widget-Parameters
        var wP = {};
        wP.nrAnimCircles = 3; //currently NOT changable
        wP.pos = {
            "invX": 180,
            "invY": 200,
            "prodX": 180,
            "prodY": 45,
            "gridX": 45,
            "gridY": 125,
            "batX": 45,
            "batY": 300,
            "houseX": 300,
            "houseY": 125,
            "carX": 300,
            "carY": 300,           
        };
        wP.textPosDeltas = {
            "prod_text_watt": [0, 20],
            "grid_text_watt": [0, -45],
            "bat_text_watt": [0, -45],
            "house_text_watt": [0, -45],
            "car_text_watt": [0, -45],
            "car_text_perc": [0, 30],
        };
        wP.maxVals = {
            "prod": 17000,
            "grid": 12000,
            "bat": 8000,
            "house": 10000,
            "car": 11000
        };
        wP.pathes = {};
        calculatePaths();

        function calculatePaths(){
            for(var i=1;i<allFlowObjects.length;i++){
                var type = allFlowObjects[i];
                wP.pathes[type] = {};
                wP.pathes[type].cur = "M0,0 " + (wP.pos.invX - wP.pos[type + 'X']).toString() + ' ' + (wP.pos.invY  - wP.pos[type + 'Y']).toString();
                wP.pathes[type].pos = "M0,0 " + (wP.pos.invX - wP.pos[type + 'X']).toString() + ' ' + (wP.pos.invY - wP.pos[type + 'Y']).toString();
                wP.pathes[type].neg = "M" + (wP.pos.invX - wP.pos[type + 'X']).toString() + ',' + (wP.pos.invY - wP.pos[type + 'Y']).toString() + ' 0 0';  
            }
        }

        function initSVG(){
            //Position and unhide SVG-Object-Groups
            for(var i=0; i < allFlowObjects.length; i++){ 
                var el = allFlowObjects[i];
                document.getElementById(el + '_group').setAttribute("x", wP.pos[el+"X"]);
                document.getElementById(el + '_group').setAttribute("y", wP.pos[el+"Y"]);
                document.getElementById(el + '_group').setAttribute("visibility", "visible");
            } 

            //run through Loop without Inverter-Object
            for(var i=1; i < allFlowObjects.length; i++){ // i = 1 because no line for Inverter
                var el = allFlowObjects[i];
                //Position and unhide Animation Lines
                document.getElementById(el + '_line').setAttribute("x1", wP.pos[el+"X"]);
                document.getElementById(el + '_line').setAttribute("y1", wP.pos[el+"Y"]);
                document.getElementById(el + '_line').setAttribute("x2", wP.pos.invX);
                document.getElementById(el + '_line').setAttribute("y2", wP.pos.invY);
                document.getElementById(el + '_line').setAttribute("visibility", "visible");
            
                //Position and unhide given Set 1 of AnimationCircles - others will be autogenerated afterwards
                document.getElementById(el + '_circle1').setAttribute("cx", wP.pos[el+"X"]);
                document.getElementById(el + '_circle1').setAttribute("cy", wP.pos[el+"Y"]);
                document.getElementById(el + '_circle1').setAttribute("visibility", "visible");

                //Position and unhide SVG-Text-Objects
                document.getElementById(el + '_text_watt').setAttribute("x", wP.pos[el+"X"] + wP.textPosDeltas[el + '_text_watt'][0]);
                document.getElementById(el + '_text_watt').setAttribute("y", wP.pos[el+"Y"] + wP.textPosDeltas[el + '_text_watt'][1]);
                document.getElementById(el + '_text_watt').setAttribute("visibility", "visible");
                if(el == 'car'){
                    document.getElementById(el + '_text_perc').setAttribute("x", wP.pos[el+"X"] + wP.textPosDeltas[el + '_text_perc'][0]);
                    document.getElementById(el + '_text_perc').setAttribute("y", wP.pos[el+"Y"] + wP.textPosDeltas[el + '_text_perc'][1]);
                    document.getElementById(el + '_text_perc').setAttribute("visibility", "visible");  
                }
            }
           
        }
        
        function getPHServerValues(){
            servConn.getStates(objIDs, (error, states) => {
                //console.log(states);
                for(var i=0; i < objIDs.length; i++){
                    //console.log(i + ' - ' + objIDs[i] + ' - ' + states[objIDs[i]].val);
                    switch(i) {
                        case 0:
                            flowValues.prod = +states[objIDs[i]].val;
                            break;
                        case 1:
                            flowValues.bat = +Math.round(states[objIDs[i]].val);
                            break;
                        case 2:
                            flowValues.grid = +Math.round(states[objIDs[i]].val) * -1;
                            break;
                        case 3:
                            flowValues.house = +Math.round(states[objIDs[i]].val);
                            break;
                        case 4:
                            flowValues.car = +Math.round(states[objIDs[i]].val);
                            break;
                        case 5:
                            flowValues.carChSt = states[objIDs[i]].val;
                            break;
                        case 6:
                            flowValues.batChSt = states[objIDs[i]].val;
                            break;
                        case 7:
                            flowValues.batStatus = states[objIDs[i]].val;
                            break;
                    }
                 }
                 
                 if(flowValues.batStatus == 1) {flowValues.bat = 0}; //if Battery Off then force value for bat to be 0

                setPathes();
                setCircleSizeAndSpeed('prod', flowValues.prod, wP.pathes.prod.cur);
                setCircleSizeAndSpeed('bat', flowValues.bat, wP.pathes.bat.cur);
                setCircleSizeAndSpeed('house', flowValues.house, wP.pathes.house.cur);
                setCircleSizeAndSpeed('car', flowValues.car, wP.pathes.car.cur);
                setCircleSizeAndSpeed('grid', flowValues.grid, wP.pathes.grid.cur);
                setTextValues();
                setBatterySVG(flowValues.batChSt);
            });
        }
        
        function addAnimCircles(number){
            for(var i=1;i<allFlowObjects.length;i++){
                var type = allFlowObjects[i];
                var el = document.getElementById(type + '_circle1');
                
                for(z=2;z<=number;z++){
                    var elCopy = el.cloneNode(true);
                    el.id = type + '_circle' + z.toString();
                    el.parentNode.insertBefore(elCopy, el.nextSibling); 
                }
            }
            
        }       
    
        function calcCircleSize(type, value){
            value = Math.abs(value);
            var maxSize = 10;
            var maxVal = wP.maxVals[type];
            var z = 2
            var res = {};
            
            //find thresholds for circle Sizes - currently 3 different sizes
            //also the duration is calculated assuming we have 3 circles running per line
            z = Math.round(value/maxVal*10); //
            if(z<3){
                res.size = 3;
                res.duration = 2;
                res.begin = 0.66;
            } else if(z<7){
                res.size = z;
                res.duration = 1.5;
                res.begin = 0.5;
            }  else if(z<=10){
                res.size = z;
                res.duration = 1;
                res.begin = 0.33;
            } else if(z>10){ //just save my ass :)
                res.size = 10;
                res.duration = 1;
                res.begin = 0.33;
            } 
    
            return res; 
        }
        
        function setCircleSizeAndSpeed(type, value, path){
            var opt = calcCircleSize(type, value);
            var animationElement = opt.aniElement;
            //var circleElement = opt.circleElement;
            var circleElement = type + '_circle';
            var beg = 0;
            for(var i=1;i<=3;i++){
                document.getElementById(circleElement + i.toString()).setAttribute("r", opt.size); 
                document.getElementById(circleElement + i.toString()).getElementsByTagName('animateMotion')[0].setAttribute("path", path);
                document.getElementById(circleElement + i.toString()).getElementsByTagName('animateMotion')[0].setAttribute("dur", opt.duration + 's');
                document.getElementById(circleElement + i.toString()).getElementsByTagName('animateMotion')[0].setAttribute("begin", beg + 's');
                
                beg = opt.begin * i;
            }
        }
        
        function formatWattNumber(val){
            
            function precisionRound(number, precision) {
                var factor = Math.pow(10, precision);
                return Math.round(number * factor) / factor;
            }
            
            var res = {};
            res.val = 0;
            res.unit = 'W';
            
            if (val > 1000){
               res.val = precisionRound(val/1000, 2);
               res.unit = 'kW';
            } else {
                res.val = val;
                res.unit = 'W';
            }
            
            return res;
        }
        
        function setTextValues(){
            var objWN = {};
            
            objWN = formatWattNumber(flowValues.prod);
            document.getElementById('prod_text_watt').textContent = objWN.val + ' ' + objWN.unit;
            objWN = formatWattNumber(flowValues.grid);
            document.getElementById('grid_text_watt').textContent = objWN.val + ' ' + objWN.unit;
            objWN = formatWattNumber(flowValues.bat);
            document.getElementById('bat_text_watt').textContent = objWN.val + ' ' + objWN.unit;
            objWN = formatWattNumber(flowValues.house);
            document.getElementById('house_text_watt').textContent = objWN.val + ' ' + objWN.unit;
            objWN = formatWattNumber(flowValues.car);
            document.getElementById('car_text_watt').textContent = objWN.val + ' ' + objWN.unit;
            document.getElementById('car_text_perc').textContent = flowValues.carChSt.toString() + "%";
            document.getElementById('percBat').textContent = flowValues.batChSt.toString() + "%";
        }
        
        function setBatterySVG(batVal){
            let colEmpty = '#F3F3F3';
            let colGreen = '#039442';
            let colOrange = '#ffdb78';
            let coldDarkOrange = '#ff5e08';
            let colRed = '#bd1b02';
    
            var col = colEmpty;
            var nrSeg = 1;
            
            if (flowValues.batStatus == 1){
                document.getElementById('batOnOff').setAttribute("fill", colRed);   
            } else {
                document.getElementById('batOnOff').setAttribute("fill", '#00cc00');
            }
            
            if(batVal < 10){
                col = colRed;
                nrSeg = 0;
            } else if (batVal < 35) {
                col = coldDarkOrange;
                nrSeg = 1;
            } else if (batVal < 75) {
                col = colOrange;
                nrSeg = 2;
            } else {
                col = colGreen;
                nrSeg = 3;            
            }
            
            for(var i=0; i<=nrSeg; i++){
                if(i<=nrSeg){
                    document.getElementById('batE' + i).setAttribute("fill", col);
                } else {
                    document.getElementById('batE' + i).setAttribute("fill", colEmpty);
                }
            }
            
        }
        
        function setPathes(){
            for (var i=1;i<allFlowObjects.length;i++){
                var typ = allFlowObjects[i];
                var val = flowValues[typ];
                
                if(typ == 'prod'){ //if it's Value of Production then we need to negotiate to have correct direction
                    val = val * -1;
                }
                
                if(val == 0) {
                    wP.pathes[typ].cur = "M0,0";
                } else if (val < 0) {
                    wP.pathes[typ].cur = wP.pathes[typ].pos;
                } else {
                    wP.pathes[typ].cur = wP.pathes[typ].neg;
                }   

                //console.log('Path of ' + typ + ': ' + wP.pathes[typ].pos);
            }
    
        }

        initSVG(); //unhide and plave SVG-Objects by given Values in Variable Definition wP
        addAnimCircles(wP.nrAnimCircles); //create copies of circle-SVGs (needed because <use> creates copies in Shadow Dom which is not accessable)
        getPHServerValues(); //"start widget" one time manually
        setInterval(getPHServerValues, 2000); //update widget every 2 seconds
    })();
    
</script>